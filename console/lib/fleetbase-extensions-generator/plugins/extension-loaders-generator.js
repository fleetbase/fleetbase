const Plugin = require('broccoli-plugin');
const fs = require('fs');
const path = require('path');

/**
 * ExtensionLoadersGeneratorPlugin
 * 
 * Generates app/utils/extension-loaders.generated.js with a map of extension names
 * to dynamic import functions.
 * 
 * Output example:
 *   export const EXTENSION_LOADERS = {
 *       '@fleetbase/fleetops-engine': () => import('../extensions/fleetops'),
 *   };
 * 
 * This file is imported by the ExtensionManager service to lazy-load extension setup code.
 */
class ExtensionLoadersGeneratorPlugin extends Plugin {
    constructor(inputNodes, options = {}) {
        super(inputNodes, {
            annotation: options.annotation || 'ExtensionLoadersGeneratorPlugin',
            persistentOutput: true,
        });
        
        this.projectRoot = options.projectRoot || process.cwd();
    }

    /**
     * Get the mount path for an extension
     */
    getExtensionMountPath(extensionName) {
        const segments = extensionName.split('/');
        let mountName = segments[1] || segments[0];
        return mountName.replace('-engine', '');
    }

    /**
     * Check if an extension has an addon/extension.js file
     */
    hasExtensionFile(extensionName) {
        const extensionPath = path.join(
            this.projectRoot,
            'node_modules',
            extensionName,
            'addon',
            'extension.js'
        );
        return fs.existsSync(extensionPath);
    }

    /**
     * Generate the extension-loaders.generated.js content
     */
    generateLoadersContent(extensions) {
        const lines = [
            '/**',
            ' * AUTO-GENERATED FILE - DO NOT EDIT',
            ' * Generated by ExtensionLoadersGeneratorPlugin',
            ' *',
            ' * This file contains a map of extension names to dynamic import functions.',
            ' * The ExtensionManager service uses this to lazy-load extension setup code',
            ' * without loading the entire engine bundle.',
            ' */',
            '',
            'export const EXTENSION_LOADERS = {',
        ];

        let loaderCount = 0;

        for (const extension of extensions) {
            const pkgName = extension.name;
            
            if (!this.hasExtensionFile(pkgName)) {
                continue;
            }

            const mountName = this.getExtensionMountPath(pkgName);
            lines.push(`    '${pkgName}': () => import('../extensions/${mountName}'),`);
            loaderCount++;
        }

        lines.push('};');
        lines.push('');

        return {
            content: lines.join('\n'),
            count: loaderCount
        };
    }

    async build() {
        console.log('[ExtensionLoadersGenerator] ========================================');
        console.log('[ExtensionLoadersGenerator] Starting loaders generation...');
        console.log('[ExtensionLoadersGenerator] Project root:', this.projectRoot);
        console.log('[ExtensionLoadersGenerator] Output path:', this.outputPath);
        
        // Read discovered extensions from cache
        const extensionsCacheFile = path.join(this.inputPaths[0], 'extensions.json');
        if (!fs.existsSync(extensionsCacheFile)) {
            console.warn('[ExtensionLoadersGenerator] No extensions cache found, skipping');
            return;
        }

        const extensions = JSON.parse(fs.readFileSync(extensionsCacheFile, 'utf8'));
        
        // Create output directory
        const outputDir = path.join(this.outputPath, 'utils');
        if (!fs.existsSync(outputDir)) {
            fs.mkdirSync(outputDir, { recursive: true });
        }

        // Generate loaders file
        const { content, count } = this.generateLoadersContent(extensions);
        const outputPath = path.join(outputDir, 'extension-loaders.generated.js');
        
        fs.writeFileSync(outputPath, content, 'utf8');

        console.log('[ExtensionLoadersGenerator] ========================================');
        console.log('[ExtensionLoadersGenerator] âœ“ Loaders generation complete');
        console.log('[ExtensionLoadersGenerator] Generated extension-loaders.generated.js with', count, 'loader(s)');
        console.log('[ExtensionLoadersGenerator] Output file:', outputPath);
        console.log('[ExtensionLoadersGenerator] ========================================');
    }
}

module.exports = ExtensionLoadersGeneratorPlugin;
