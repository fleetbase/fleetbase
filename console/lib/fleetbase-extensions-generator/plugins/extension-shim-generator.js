const Plugin = require('broccoli-plugin');
const fs = require('fs');
const path = require('path');

/**
 * ExtensionShimGeneratorPlugin
 * 
 * Generates app/extensions/*.js shim files by INLINING the extension.js code
 * from each engine's addon directory. This enables code splitting - the extension
 * setup code can be dynamically imported without loading the entire engine bundle.
 * 
 * This is critical for performance: extension setup runs at boot, but engines
 * are lazy-loaded only when their routes are accessed.
 */
class ExtensionShimGeneratorPlugin extends Plugin {
    constructor(inputNodes, options = {}) {
        super(inputNodes, {
            annotation: options.annotation || 'Generate Extension Shims',
            persistentOutput: true,
            needsCache: false
        });
        
        this.projectRoot = options.projectRoot || process.cwd();
    }

    async build() {
        console.log('[ExtensionShimGenerator] ========================================');
        console.log('[ExtensionShimGenerator] Starting shim generation...');
        console.log('[ExtensionShimGenerator] Project root:', this.projectRoot);
        console.log('[ExtensionShimGenerator] Output path:', this.outputPath);
        
        const extensionsJsonPath = path.join(this.inputPaths[0], 'extensions.json');
        console.log('[ExtensionShimGenerator] Reading extensions from:', extensionsJsonPath);        
        // Check if extensions.json exists
        if (!fs.existsSync(extensionsJsonPath)) {
            console.warn('[ExtensionShimGenerator] extensions.json not found, skipping');
            return;
        }
        
        // Read discovered extensions
        const extensions = JSON.parse(fs.readFileSync(extensionsJsonPath, 'utf8'));
        
        // Create extensions output directory
        const extensionsDir = path.join(this.outputPath, 'extensions');
        if (!fs.existsSync(extensionsDir)) {
            fs.mkdirSync(extensionsDir, { recursive: true });
        }
        
        let shimCount = 0;
        
        for (const extension of extensions) {
            const pkgName = extension.name;
            const mountName = this.#getExtensionMountPath(pkgName);
            
            // Path to extension.js in the engine's addon directory
            const extensionPath = path.join(
                this.projectRoot,
                'node_modules',
                pkgName,
                'addon',
                'extension.js'
            );
            
            // Check if extension.js exists
            if (!fs.existsSync(extensionPath)) {
                console.log(`[ExtensionShimGenerator] No extension.js found for ${pkgName}, skipping`);
                continue;
            }
            
            // Read the extension code
            let extensionCode;
            try {
                extensionCode = fs.readFileSync(extensionPath, 'utf8');
            } catch (error) {
                console.error(`[ExtensionShimGenerator] Failed to read extension.js for ${pkgName}:`, error.message);
                continue;
            }
            
            // Generate shim filename (e.g., 'fleetops.js')
            const shimPath = path.join(extensionsDir, `${mountName}.js`);
            
            // INLINE the extension code instead of re-exporting
            // This is critical: we copy the code so it can be bundled by ember-auto-import
            // without requiring the engine to be loaded
            const shimContent = `// GENERATED BY extension-shim-generator.js - DO NOT EDIT
// Extension setup for ${pkgName}
//
// This file contains the inlined extension setup code from the engine.
// It is generated at build time to enable dynamic import without loading
// the entire engine bundle.

${extensionCode}
`;
            
            try {
                fs.writeFileSync(shimPath, shimContent, 'utf8');
                shimCount++;
                console.log(`[ExtensionShimGenerator] ✓ Inlined extension code for ${pkgName} → ${mountName}.js`);
            } catch (error) {
                console.error(`[ExtensionShimGenerator] Failed to write shim for ${pkgName}:`, error.message);
            }
        }
        
        console.log('[ExtensionShimGenerator] ========================================');
        console.log('[ExtensionShimGenerator] ✓ Shim generation complete');
        console.log('[ExtensionShimGenerator] Generated', shimCount, 'extension shim file(s)');
        console.log('[ExtensionShimGenerator] Output directory:', path.join(this.outputPath, 'extensions'));
        console.log('[ExtensionShimGenerator] ========================================');
    }

    /**
     * Extract the mount path from an extension package name
     * @param {string} extensionName - e.g., '@fleetbase/fleetops-engine'
     * @returns {string} - e.g., 'fleetops'
     */
    #getExtensionMountPath(extensionName) {
        const segments = extensionName.split('/');
        let mountName = segments[1] || segments[0];
        return mountName.replace('-engine', '');
    }
}

module.exports = ExtensionShimGeneratorPlugin;
