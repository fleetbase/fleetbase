const fs = require('fs');
const path = require('path');

/**
 * Get the mount path for an extension from its package name
 */
function getExtensionMountPath(packageName) {
    return packageName.replace('@fleetbase/', '').replace('-engine', '');
}

/**
 * Generate extension shim files in app/extensions/
 */
function generateExtensionShims(projectRoot, extensions) {
    console.log('[fleetbase-extensions-generator] Generating extension shims...');

    const extensionsDir = path.join(projectRoot, 'app', 'extensions');

    // Create extensions directory if it doesn't exist
    if (!fs.existsSync(extensionsDir)) {
        fs.mkdirSync(extensionsDir, { recursive: true });
    }

    let generatedCount = 0;

    for (const extension of extensions) {
        const extensionPath = path.join(projectRoot, 'node_modules', extension.name, 'addon', 'extension.js');

        if (!fs.existsSync(extensionPath)) {
            continue;
        }

        // Read the extension.js content
        const extensionContent = fs.readFileSync(extensionPath, 'utf8');

        // Get mount name
        const mountName = extension.fleetbase?.route?.slug || getExtensionMountPath(extension.name);

        // Generate the shim file that inlines the extension code
        const shimContent = `// Auto-generated extension shim for ${extension.name}
// This file is generated by fleetbase-extensions-generator
// DO NOT EDIT MANUALLY

${extensionContent}
`;

        const shimFile = path.join(extensionsDir, `${mountName}.js`);

        try {
            fs.writeFileSync(shimFile, shimContent, 'utf8');
            console.log('[fleetbase-extensions-generator]   âœ“ Generated app/extensions/' + mountName + '.js');
            generatedCount++;
        } catch (error) {
            console.error('[fleetbase-extensions-generator]   ! Failed to write extension shim:', error.message);
        }
    }

    console.log('[fleetbase-extensions-generator] Generated', generatedCount, 'extension shim(s)');
}

module.exports = generateExtensionShims;
