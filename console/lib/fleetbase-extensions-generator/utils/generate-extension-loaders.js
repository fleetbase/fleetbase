const fs = require('fs');
const path = require('path');

/**
 * Get the mount path for an extension from its package name
 */
function getExtensionMountPath(packageName) {
    return packageName.replace('@fleetbase/', '').replace('-engine', '');
}

/**
 * Generate extension loaders map in app/utils/extension-loaders.generated.js
 */
function generateExtensionLoaders(projectRoot, extensions) {
    console.log('[fleetbase-extensions-generator] Generating extension loaders...');

    const utilsDir = path.join(projectRoot, 'app', 'utils');

    // Create utils directory if it doesn't exist
    if (!fs.existsSync(utilsDir)) {
        fs.mkdirSync(utilsDir, { recursive: true });
    }

    // Build the loaders map
    const loaders = {};

    for (const extension of extensions) {
        const extensionPath = path.join(projectRoot, 'node_modules', extension.name, 'addon', 'extension.js');

        if (!fs.existsSync(extensionPath)) {
            continue;
        }

        const mountName = extension.fleetbase?.route?.slug || getExtensionMountPath(extension.name);
        loaders[extension.name] = `() => import('@fleetbase/console/extensions/${mountName}')`;
    }

    // Generate the loaders file
    const loadersContent = `// Auto-generated extension loaders
// This file is generated by fleetbase-extensions-generator
// DO NOT EDIT MANUALLY

export const EXTENSION_LOADERS = {
${Object.entries(loaders)
    .map(([name, loader]) => `    '${name}': ${loader}`)
    .join(',\n')}
};

export default EXTENSION_LOADERS;
`;

    const loadersFile = path.join(utilsDir, 'extension-loaders.generated.js');

    try {
        fs.writeFileSync(loadersFile, loadersContent, 'utf8');
        console.log('[fleetbase-extensions-generator]   âœ“ Generated app/utils/extension-loaders.generated.js with', Object.keys(loaders).length, 'loader(s)');
    } catch (error) {
        console.error('[fleetbase-extensions-generator]   ! Failed to write extension loaders:', error.message);
    }
}

module.exports = generateExtensionLoaders;
